"===============================================================================
" åŸºæœ¬è®¾å®š
"===============================================================================

" å…³é—­ Vi å…¼å®¹æ¨¡å¼ï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨ Vim çš„å¤§éƒ¨åˆ†æ‰©å±•åŠŸèƒ½
set nocompatible

" ç¦ç”¨èœå•æ ç­‰ï¼Œä¸æ”¾åœ¨ .gvimrc ä»¥é¿å…å¯åŠ¨æ—¶æ™ƒåŠ¨
"set guioptions+=M
runtime menu.vim
"set guioptions-=m
set guioptions-=t
set winaltkeys=no

" è‡ªåŠ¨ç¼©è¿›è®¾ç½®
" ä½¿æ–°è¡Œç¼©è¿›ä¸å‰ä¸€è¡Œä¸€æ ·
set autoindent
" ä¸»è¦æ˜¯å®ç°è‡ªåŠ¨å¯¹é½å¤§æ‹¬å·çš„ç¼©è¿›
set smartindent
" æ‰“å¼€ cindentï¼Œä¸»è¦ä½“ç°ä¸ºå‡½æ•°å‚æ•°è¿‡é•¿æ—¶ï¼Œæ¢è¡Œè‡ªåŠ¨ç¼©è¿›
set cindent
set cinoptions+=(0,W8

" æ€»åœ¨ vim çª—å£çš„å³ä¸‹è§’æ˜¾ç¤ºå½“å‰å…‰æ ‡ä½ç½®ã€‚
"set ruler
" ç”¨ statusline æ¨¡æ‹Ÿ
"set statusline=%<%f\ %h%m%r%=%-13.(%l,%c%V%)\ %P
set statusline=%<%f\ %h%w%m%r%y[%{&ff}]%([%{&fileencoding}]%)
            \%{GetFmt()}%=%(%l/%L,%c%V%)\ %P
set laststatus=2
function! GetFmt() "{{{
    let l:fmt = getftime(expand("%:p"))
    if l:fmt != -1
        return "[". strftime("%Y-%m-%d %H:%M:%S", l:fmt) . "]"
    else
        return ""
    endif
endf "}}}

" åœ¨ vim çª—å£å³ä¸‹è§’ï¼Œæ ‡å°ºçš„å³è¾¹æ˜¾ç¤ºæœªå®Œæˆçš„å‘½ä»¤ã€‚
set showcmd

" å·¦ä¸‹è§’æ˜¾ç¤ºå½“å‰æ¨¡å¼
set showmode

" è¯­æ³•é«˜äº®
syntax on
" ç¦ç”¨ vim æ–‡ä»¶ç±»å‹çš„é”™è¯¯
let g:vimsyn_noerror = 1

" æ–‡ä»¶ç±»å‹çš„æ£€æµ‹
"filetype on
" ä¸ºç‰¹å®šçš„æ–‡ä»¶ç±»å‹å…è®¸æ’ä»¶æ–‡ä»¶çš„è½½å…¥
"filetype plugin on
" ä¸ºç‰¹å®šçš„æ–‡ä»¶ç±»å‹è½½å…¥ç¼©è¿›æ–‡ä»¶
"filetype indent on
" å¯ä»¥ç›´æ¥ç”¨ä¸‹é¢ä¸€è¡Œå®Œæˆ
filetype plugin indent on


" ç¦ç”¨å“é“ƒ
"set noerrorbells
" ç¦ç”¨é—ªå±
"set vb t_vb=

" æ˜¾ç¤ºè¡Œå·
"set number

" è®¾å®šæ–‡ä»¶ç¼–ç ç±»å‹ï¼Œå½»åº•è§£å†³ä¸­æ–‡ç¼–ç é—®é¢˜
let &termencoding=&encoding
set fileencodings=utf-8,gbk,gb18030,ucs-bom,cp936

" è®¾ç½®æœç´¢ç»“æœé«˜äº®æ˜¾ç¤º
set hlsearch
" æœç´¢æ—¶å¿½ç•¥å¤§å°å†™
set ignorecase
set smartcase
" åœ¨æœç´¢æ¨¡å¼æ—¶è¾“å…¥æ—¶å³æ—¶æ˜¾ç¤ºç›¸åº”çš„åŒ¹é…ç‚¹ã€‚
set incsearch

" è®¾ç½®ä¸è‡ªåŠ¨å¤‡ä»½
set nobackup
" ä¿ç•™åŸå§‹æ–‡ä»¶
"set patchmode=.orig

" å¯åŠ¨å¯¹é¼ æ ‡çš„æ”¯æŒ
set mouse=a

" ç¬¬ä¸€è¡Œè®¾ç½®tabé”®ä¸º4ä¸ªç©ºæ ¼ï¼Œç¬¬äºŒè¡Œè®¾ç½®å½“è¡Œä¹‹é—´äº¤é”™æ—¶ä½¿ç”¨4ä¸ªç©ºæ ¼
"set tabstop=4
set softtabstop=4
set shiftwidth=4
set expandtab

" é•¿è¡Œä¸èƒ½å®Œå…¨æ˜¾ç¤ºæ—¶æ˜¾ç¤ºå½“å‰å±å¹•èƒ½æ˜¾ç¤ºçš„éƒ¨åˆ†ï¼Œé•¿è¡Œä¸èƒ½å®Œå…¨æ˜¾ç¤ºæ—¶æ˜¾ç¤º @
set display=lastline

" ä¸Šä¸‹ä¸ºè·¨å±å¹•ä¸€è¡Œ
noremap <silent> k gk
noremap <silent> j gj

" è‡ªåŠ¨ç»•è¡Œæ˜¾ç¤º
set wrap
" æŒ‰è¯ç»•è¡Œ
"set linebreak
" å›ç»•è¡Œçš„å‰å¯¼ç¬¦å·
"set showbreak=<-->

" è®¾ç½®é¼ æ ‡å’Œé€‰æ‹©çš„è¡Œä¸º
set selectmode=key
set mousemodel=popup
set keymodel=startsel,stopsel
set selection=inclusive
if has("win32") || has("win64")
    " nop
else
    " ä¿®æ­£é¼ æ ‡å³é”®èœå•è¡Œä¸º
    noremap <RightMouse> <Nop>
    noremap <RightRelease> <RightMouse>
    noremap! <RightMouse> <Nop>
    noremap! <RightRelease> <RightMouse>
    " æ²¡ç”¨çš„ 3ã€4 è¿å‡»
    noremap <3-LeftMouse> <Nop>
    noremap! <3-LeftMouse> <Nop>
    noremap <4-LeftMouse> <Nop>
    noremap! <4-LeftMouse> <Nop>
endif

" å…¨èƒ½è¡¥å…¨ç¦æ­¢é¢„è§ˆ
"set completeopt=longest,menu
"set completeopt=menuone,preview
set completeopt=menuone

" æ˜¾ç¤ºæ°´å¹³æ»šåŠ¨æ¡
"set guioptions+=b

" ä¿®æ”¹<Leader>é”®
"let mapleader = "\\"
let mapleader = "\<F12>"

" ä»£ç è‡ªåŠ¨æŠ˜å è®¾ç½®ã€‚
set foldenable     " æ‰“å¼€ä»£ç æŠ˜å 
"set nofoldenable   " å…³é—­ä»£ç æŠ˜å 
" ä»£ç æŠ˜å ï¼Œæ ¹æ®è¯­æ³•
set foldmethod=syntax
" ä»£ç æŠ˜å ï¼Œæ‰‹åŠ¨
"set foldmethod=manual
" æ˜¾ç¤ºæŠ˜å åˆ—
if has('gui_running')
    autocmd syntax vim setlocal foldcolumn=1
    autocmd syntax c,cpp setlocal foldcolumn=1
endif
" è®¾ç½®æŠ˜å çº§åˆ«: é«˜äºæ­¤çº§åˆ«çš„æŠ˜å ä¼šè¢«å…³é—­
set foldlevel=9999

" å…è®¸å…‰æ ‡ç§»åŠ¨åˆ°åˆšåˆšè¶…è¿‡è¡Œå°¾å­—ç¬¦ä¹‹åçš„ä½ç½®
set virtualedit=onemore,block

" çª—å£å¤§å°ï¼Œæ›´é€‚åˆæ”¾åˆ° .gvimrc
"set columns=100 lines=40

" æ ‡ç­¾é¡µæ˜¾ç¤ºã€‚0:1:2 = æ€»æ˜¯ä¸æ˜¾ç¤ºï¼šè¶…è¿‡ä¸€ä¸ªæ‰æ˜¾ç¤ºï¼šæ€»æ˜¯æ˜¾ç¤º
"set showtabline=2

" è‡ªåŠ¨å®Œæˆæ‰«æçš„æ–‡ä»¶
" ç¼ºçœ ".,w,b,u,t,i"
" å½“å‰ç¼“å†²åŒºï¼Œå…¶ä»–çª—å£çš„bufï¼Œå…¶ä»–è½½å…¥çš„bufï¼Œå¸è½½çš„bufï¼Œæ ‡ç­¾ï¼Œå¤´æ–‡ä»¶
"set complete=.,w,b,u,t,i
"set complete=.,t,i
set complete=.,t,w,b,k

" æ³¨æ„: æ‰“å¼€æ¬¡é€‰é¡¹ä¼šä½¿å¾—æŸäº›æ’ä»¶æ— æ³•å·¥ä½œã€‚
"set autochdir

" åˆ‡æ¢æ—¶éšè—ç¼“å†²è€Œä¸æ˜¯æç¤ºå·²ä¿®æ”¹æœªä¿å­˜
set hidden

" æ˜¾ç¤º 80 å­—ç¬¦å³è¾¹è·çš„å®ç°ï¼Œéœ€è¦ 7.3 ä»¥ä¸Šç‰ˆæœ¬
if version >= 703 && has("gui_running")
    set cc=81
endif

" è®¾ç½® session æ–‡ä»¶ä¿å­˜çš„ä¿¡æ¯
" (ç¼ºçœ: "blank,buffers,curdir,folds,help,options,tabpages,winsize")
set sessionoptions=buffers,curdir,folds,help,localoptions,tabpages,winsize,resize

" æ™®é€šæ¨¡å¼å’Œæ’å…¥æ¨¡å¼çš„å…‰æ ‡è®¾ç½®
let color_normal = 'grey'
let color_insert = 'magenta'
let color_exit = 'grey'
if &term == "linux" || &term == "fbterm" "{{{
    " console fbterm é€šç”¨
    let g:loaded_vimcdoc = 0
    set t_ve+=[?6c
    autocmd! InsertEnter * set t_ve-=[?6c
    autocmd! InsertLeave * set t_ve+=[?6c
    autocmd! VimLeave * set t_ve-=[?6c
"elseif &term == "xterm"
    " konsole
    "let &t_EI = "\<Esc>]50;CursorShape=0\x7"
    "let &t_SI = "\<Esc>]50;CursorShape=1\x7"
elseif &term == "xterm-256color"
    " gnome-terminal xterm é€šç”¨
    let &t_EI = "\<Esc>]12;" . color_normal . "\x7" " æ™®é€šæ¨¡å¼çš„å…‰æ ‡é¢œè‰²
    let &t_SI = "\<Esc>]12;" . color_insert . "\x7" " æ’å…¥æ¨¡å¼çš„å…‰æ ‡é¢œè‰²
elseif &term =~ "screen"
    set ttymouse=xterm2
    if exists('$TMUX')
        " tmux
        exec 'silent !echo -ne "\033Ptmux;\033\e]12;"'
                    \ . shellescape(color_normal, 1) . '"\007\033\\"'
        let &t_SI="\033Ptmux;\033\e]12;" . color_insert . "\007\033\\"
        let &t_EI="\033Ptmux;\033\e]12;" . color_normal . "\007\033\\"
        exec 'autocmd VimLeave * :silent !echo -ne "\033Ptmux;\033\e]12;"'
                    \ . shellescape(color_exit, 1) . '"\007\033\\"'
    else
        " screen
        exec 'silent !echo -ne "\033P\e]12;"'
                    \ . shellescape(color_normal, 1) . '"\007\033\\"'
        let &t_SI="\033P\e]12;" . color_insert . "\007\033\\"
        let &t_EI="\033P\e]12;" . color_normal . "\007\033\\"
        exec 'autocmd VimLeave * :silent !echo -ne "\033P\e]12;"'
                    \ . shellescape(color_exit, 1) . '"\007\033\\"'
    endif
elseif &term =~ 'xterm.\+'
    " xterm
    " 0 or 1 -> blinking block
    " 2 -> solid block
    " 3 -> blinking underscore
    " 4 -> solid underscore
    let &t_EI = "\<Esc>[0 q"
    let &t_SI = "\<Esc>[3 q"
endif
unlet color_normal
unlet color_insert
unlet color_exit
"}}}
" è®¾ç½® gnome-terminal çš„å…‰æ ‡
"if &term == "xterm" && !has("gui_running") "{{{
    "silent execute "!gconftool-2 --type string --set /apps/gnome-terminal/profiles/Default/cursor_shape block"
    "autocmd! InsertEnter * silent execute "!gconftool-2 --type string --set /apps/gnome-terminal/profiles/Default/cursor_shape ibeam"
    "autocmd! InsertLeave * silent execute "!gconftool-2 --type string --set /apps/gnome-terminal/profiles/Default/cursor_shape block"
    "autocmd! VimLeave * silent execute "!gconftool-2 --type string --set /apps/gnome-terminal/profiles/Default/cursor_shape underline"
"endif
"}}}
" ç¼–è¾‘ po æ–‡ä»¶æ—¶ä¸ä¸­æ–‡è¾“å…¥æ³•çš„é…åˆ
autocmd! syntax po set imactivatekey=C-space

" fcitx è¾“å…¥æ³•è°ƒæ•´ï¼Œç¦»å¼€æ’å…¥æ¨¡å¼æ—¶è‡ªåŠ¨å…³é—­è¾“å…¥æ³•
" NOTE: ä½¿ç”¨æ’ä»¶æ¥å®ç°ï¼Œä¸åœ¨è¿™é‡Œå®ç°äº†
"if executable("fcitx-remote") && exists("$DISPLAY")
    "autocmd InsertLeave * call system("fcitx-remote -c")
"endif

" é¢œè‰²æ–¹æ¡ˆ
if has('gui_running')   " gui çš„æƒ…å†µä¸‹
    colorscheme desertEx
elseif &t_Co == 256     " æ”¯æŒ 256 è‰²çš„è¯
    colorscheme desertEx256
elseif $TERM ==# "xterm"
    colorscheme default
else
    colorscheme default
endif

" å¢å¼ºçš„å‘½ä»¤è¡Œè¡¥å…¨
set wildmenu

" æ‰§è¡Œå®ã€å¯„å­˜å™¨å’Œå…¶å®ƒä¸é€šè¿‡è¾“å…¥çš„å‘½ä»¤æ—¶å±å¹•ä¸ä¼šé‡ç”»
"set lazyredraw

" è®¾ç½®é”®ç å»¶æ—¶, é¿å…ç»ˆç«¯ä¸‹ <ESC> çš„ç­‰å¾…
set ttimeoutlen=50

" ç”¨ç©ºæ ¼æ¥æ˜¾ç¤ºåˆ¶è¡¨å¹¶åŒæ—¶æŠŠå…‰æ ‡æ”¾åœ¨ç©ºç™½å¼€å§‹ä½ç½®
set list listchars=tab:\ \ 

" åˆ é™¤ç¯å¢ƒå˜é‡ LANGUAGEï¼Œä¸ç„¶ä¼šå½±å“æŸäº›æ’ä»¶æ— æ³•æå–è‹±æ–‡ç¯å¢ƒä¸‹çš„å‘½ä»¤è¾“å‡º
let $LANGUAGE=''

"===============================================================================
" é¢å¤–çš„æ–‡ä»¶æ ¼å¼æ”¯æŒ
"===============================================================================

" ========== ç‰¹æ®Šæ–‡ä»¶æ ¼å¼ ==========
" txt2tags æ ¼å¼æ–‡ä»¶é«˜äº®
autocmd! BufNewFile,BufRead *.t2t set ft=txt2tags
"asciidoc æ ¼å¼æ–‡ä»¶é«˜äº®
autocmd! BufNewFile,BufRead *.adc set ft=asciidoc
" vimhelp(è‡ªå®šä¹‰) æ ¼å¼æ–‡ä»¶é«˜äº®
"autocmd! BufNewFile,BufRead *.vhp set tw=78 ts=4 ft=help norl
" Org-Mode
"autocmd BufEnter *.org call org#SetOrgFileType()
autocmd! BufNewFile,BufRead *.org set ft=org
" NetWide Assembly
autocmd! BufNewFile,BufRead *.nasm setf nasm
" rfc
autocmd! BufNewFile,BufRead *.txt
    \ if expand('%:t') =~# 'rfc\d\+\.txt' | setf rfc | endif

"===============================================================================
" å¸¸è§„é”®ç›˜æ˜ å°„
"===============================================================================

"=======================================
" æ™®é€šæ¨¡å¼
"=======================================
function! s:n_BuffterDelete() "{{{
    let curb = bufnr('%')
"   if bufexists(0)     " æ£€æŸ¥æ˜¯å¦å­˜åœ¨è½®æ¢ç¼“å†²
    bNext
    exec "bd " . curb
    if exists("*BufExplorer_Fix")
        call BufExplorer_Fix()
    endif
endf
"}}}
nnoremap <silent> \- :set columns-=30<CR>
nnoremap <silent> \= :set columns+=30<CR>
nnoremap <silent> \l :%s/\r//g<CR>
nnoremap <silent> \d :call <SID>n_BuffterDelete()<CR>
nnoremap \h :cd %:p:h <Bar> pwd<CR>
nnoremap \] :mksession! vimp.vim <Bar> wviminfo! vimp.vi<CR>
nnoremap <Space> 3<C-e>
nnoremap <S-Space> 3<C-y>
nnoremap , 3<C-y>
nnoremap <C-h> <C-w>h
nnoremap <C-j> <C-w>j
nnoremap <C-k> <C-w>k
nnoremap <C-l> <C-w>l
nnoremap ; :
"nnoremap <C-a> ggVG
nnoremap <C-Tab> :bnext<CR>
nnoremap <S-Tab> :bNext<CR>
nnoremap <C-s> :update<CR>
"nnoremap <CR> <C-w>}
nnoremap <C-p> <C-w>z
nnoremap T :tag<CR>
"nnoremap <C-z> u
if exists('$DISPLAY')
    nnoremap <C-v> "+gP
endif

" äº¤æ¢ ' å’Œ `ï¼Œå› ä¸º ` æ¯” ' å¸¸ç”¨ä½†å¤ªè¿œ
nnoremap ' `
nnoremap ` '

"=======================================
" å‘½ä»¤è¡Œæ¨¡å¼ï¼ŒåŒ…æ‹¬æœç´¢æ—¶
"=======================================
cnoremap <C-h> <Left>
cnoremap <C-j> <Down>
cnoremap <C-k> <Up>
cnoremap <C-l> <Right>
cnoremap <C-a> <Home>
cnoremap <C-BS> <C-w>
cnoremap <C-d> <Del>
if exists('$DISPLAY')
    cnoremap <C-v> <C-r>+
endif

"cnoremap <A-m> <Esc>
"cnoremap qq q!
"cnoremap cc close
"cnoremap ccc close!<CR>

"=======================================
" å¯è§†å’Œé€‰æ‹©æ¨¡å¼
"=======================================
if exists('$DISPLAY')
    vnoremap <C-x> "+x
    vnoremap <C-c> "+y
    vnoremap <C-v> "+gP
endif
vnoremap <C-s> <C-c>:update<CR>
"vnoremap y "+y
"vnoremap x "+x

"=======================================
" å¯è§†æ¨¡å¼
"=======================================
function! MacroComment() "{{{
    let l:firstline = line("'<")
    let l:lastline = line("'>")
    let l:curline = line(".")
    exec l:firstline . "put! ='#if 0'"
    exec l:lastline + 1 . "put ='#endif'"
    exec l:curline + 1
endf
"}}}
xnoremap <Space> 3j
xnoremap , 3k
xnoremap ( di()<ESC>Pl
xnoremap [ di[]<ESC>Pl
xnoremap ' di''<ESC>Pl
xnoremap " di""<ESC>Pl

" é€‰æ‹©åç«‹å³æœç´¢
xnoremap / y:let @" = substitute(@", '\\', '\\\\', "g")<CR>
    \:let @" = substitute(@", '\/', '\\\/', "g")<CR>/\V<C-r>"<CR>N
" C æ–‡ä»¶çš„ #if 0 æ®µè½æ³¨é‡Š
xnoremap 0 <C-c>:call MacroComment()<CR>


"=======================================
" æ’å…¥æ¨¡å¼ä¸‹
"=======================================
function! s:ToggleCase() "{{{
    let sLine = getline('.')
    let nEndIdx = col('.') - 2
    let sWord = matchstr(sLine[: nEndIdx], '\zs\k*\ze$')
    if sWord ==# ''
        return ''
    endif

    if sWord =~# '[a-z]'
        call setline(line('.'), substitute(sLine[: nEndIdx], '\zs\k*\ze$', 
                    \   toupper(sWord), '') . sLine[nEndIdx+1 :])
    else
        call setline(line('.'), substitute(sLine[: nEndIdx], '\zs\k*\ze$', 
                    \   tolower(sWord), '') . sLine[nEndIdx+1 :])
    endif

    return ''
endf
"}}}
"inoremap <silent> <C-s> <C-o>:update<CR>
inoremap <silent> <C-s> <ESC>:update<CR>
inoremap <C-CR> <ESC>o
inoremap <S-CR> <ESC>O
inoremap <expr> <C-e> pumvisible()?"\<C-e>":"\<END>"
inoremap <C-a> <Home>
inoremap <C-BS> <C-w>
inoremap <C-d> <Del>
if exists('$DISPLAY')
    inoremap <C-v> <C-r>+
endif

inoremap <C-z> <C-o>u
inoremap <C-r> <C-o><C-r>
" å†™ C æ—¶éº»çƒ¦çš„å®å®šä¹‰å¤§å†™é—®é¢˜ï¼Œè§£å†³ï¼
inoremap <silent> <expr> <C-y>
    \ pumvisible()?"\<C-y>":"\<C-r>=<SID>ToggleCase()\<CR>"

imap <C-h> <Left>
imap <C-j> <Down>
imap <C-k> <Up>
imap <C-l> <Right>
inoremap <A-h> <C-Left>
inoremap <A-l> <C-Right>


"===============================================================================
" æ’ä»¶è®¾ç½®
"===============================================================================
" ========== taglist ==========
"{{{
" æ‰“å¼€/å…³é—­å‘½ä»¤:":TlistToggle"
" ä¸åŒæ—¶æ˜¾ç¤ºå¤šä¸ªæ–‡ä»¶çš„tagï¼Œåªæ˜¾ç¤ºå½“å‰æ–‡ä»¶çš„
let Tlist_Show_One_File = 1
" å¦‚æœtaglistçª—å£æ˜¯æœ€åä¸€ä¸ªçª—å£ï¼Œåˆ™é€€å‡ºvim
let Tlist_Exit_OnlyWindow = 1
" å•å‡»æ ‡ç­¾å³è¾¾
let Tlist_Use_SingleClick=1
" æ–‡ä»¶éç¼–è¾‘æ—¶è‡ªåŠ¨å…³é—­ä¾§æ 
"let Tlist_File_Fold_Auto_Close=1
" ä¸æ˜¾ç¤ºæŠ˜å é¡µè¾¹
let g:Tlist_Enable_Fold_Column = 0
" åœ¨å³è¾¹æ‰“å¼€çª—å£
let Tlist_Use_Right_Window = 1
" æ‰“å¼€æ—¶ä¸å¢åŠ çª—å£å®½åº¦
let Tlist_Inc_Winwidth = 0
" é»˜è®¤æ’åºæ–¹å¼
let Tlist_Sort_Type = "name"
" ctags.exe
if has("win32") || has("win64")
    let Tlist_Ctags_Cmd = $VIM . '\vimfiles\bin\ctags.exe'
endif
"
"highlight MyTagListTagName guifg=cyan guibg=grey40 ctermfg=white ctermbg=green
highlight link MyTagListTagName Search
highlight MyTagListFileName guifg=lightgoldenrod2 ctermfg=white
"}}}
" ========== tagbar ==========
"{{{
let g:tagbar_compact = 1
let g:tagbar_width = 30
"let g:tagbar_expand = 1
if has("win32") || has("win64")
    let g:tagbar_ctags_bin = $VIM . '\vimfiles\bin\ctags.exe'
endif

let g:tagbar_type_rfc = {
    \ 'ctagstype' : 'rfc',
    \ 'kinds'     : [
        \ 'c:chapters',
    \ ],
    \ 'sort'    : 0,
    \ 'deffile' : expand('~/.vim/ctags/rfc.cnf'),
\ }

nnoremap <Leader>t :TagbarToggle<CR>

hi TagbarAccessProtected guifg=Magenta ctermfg=Magenta
hi link TagbarSignature Normal
hi link TagbarKind Constant
"}}}
" ========== NERDTree ==========
"{{{
" è®¾ç½®ä¸æ˜¾ç¤ºçš„æ–‡ä»¶ï¼Œæ•ˆæœä¸ºä»…æ˜¾ç¤º .c,.cpp,.h æ–‡ä»¶ï¼Œæ— åç¼€åæ–‡ä»¶æš‚æ—¶æ— æ³•è§£å†³
"let NERDTreeIgnore = ['\(\.cpp$\|\.c$\|\.h$\|\.cxx\|\.hpp\)\@!\..\+', '\~$']
let NERDTreeIgnore = []
hi link treeDir Statement
hi link treeCWD Type
"}}}
" ========== Vimwiki ==========
"{{{
let g:vimwiki_camel_case = 0
" ä»¤é¢„æ ¼å¼åŒ–æ–‡æœ¬æ”¯æŒè¯­æ³•é«˜äº®ï¼ŒåŒæ—¶å¯ä»¥å¼ºåˆ¶åˆ·æ–°é¢„æ ¼å¼åŒ–æ–‡æœ¬
let wiki = {}
let wiki.path = '~/my_wiki/'
let wiki.path_html = '~/my_html/'
let wiki.nested_syntaxes = {'c++': 'cpp', 'python': 'python'}
let g:vimwiki_list = [wiki]
let g:vimwiki_hl_cb_checked = 1
let g:vimwiki_CJK_length = 1
let g:vimwiki_browsers=['/usr/bin/firefox']
let g:vimwiki_html_header_numbering = 2
let g:vimwiki_menu = ''
" ç¦ç”¨æ’å…¥æ¨¡å¼çš„è¡¨æ ¼å¿«æ·é”®ï¼Œä»¥é˜²å ç”¨ <Cr> å’Œ <Tab>
let g:vimwiki_table_mappings = 0

" å®šåˆ¶ä¸€ä¸‹è¯­æ³•é«˜äº®
hi link VimwikiPre Ignore

" ä¸€äº›ç‰¹å®šçš„è®¾ç½®
autocmd! FileType vimwiki call <SID>VimwikiSetup()
function! s:VimwikiSetup()
    " è¿™ä¸ªåŠ¨ä½œé»˜è®¤æŒ‰é”®æ˜¯ <C-Space>ï¼Œå¤ªæ“äº†ï¼Œè€Œ <C-n> åˆè¢« NERD commenter å ç”¨
    nmap <buffer> <C-n> <Plug>VimwikiToggleListItem
    setlocal sts=4 ts=4 sw=4 et
endfunction
"}}}
" ========== NERD commenter ==========
"{{{
let NERDMenuMode = 0
"let NERDSpaceDelims = 1
nmap <C-n> <Leader>c<space><Down>
xmap <C-n> <Leader>c<space>
"}}}
" ========== pydiction ==========
"{{{
let g:pydiction_location = '~/.vim/dict/complete-dict'
"let g:pydiction_menu_height = 20
"}}}
" ========== VLOmniCpp ==========
"{{{
" æ˜¾ç¤ºç§æœ‰æˆå‘˜
let g:VLOmniCpp_DisplayMode = 1
" è‡ªå®šä¹‰é€‰é¡¹
let g:VLOmniCpp_ItemSelectionMode = 10
" æš‚æ—¶æ²¡æœ‰ç”¨åˆ°
"let g:VimTagsManager_SrcDir = '~/.vimlite/VimLite'
" åŸºäº VLWorkspace çš„æº/å¤´æ–‡ä»¶åˆ‡æ¢
nnoremap <silent> <C-\>a :VLWSwapSourceHeader<CR>
" å¼¹å‡º GUI èœå•çš„å¿«æ·é”®
let g:VLWPopupMenuKey = '<RightRelease>'
"}}}
" ========== VimLite ==========
"{{{
"let g:VLWorkspaceUseVIMCCC = 1
let g:VLWorkspaceSaveAllBeforeBuild = 1
let g:VLWorkspaceParseFileAfterSave = 1
let g:VLCalltips_IndicateArgument = 0
let g:VLCalltips_EnableSyntaxTest = 0
let g:VLWDbgSaveBreakpointsInfo = 1
let g:VLOmniCpp_UseLibCxxParser = 1
let g:VLWDisableUnneededTools = 0
let g:VLWorkspaceLinkToEidtor = 0
if has("win32") || has("win64")
    let g:VLOmniCpp_LibCxxParserPath = expand($VIM.'/vimlite/lib/libCxxParser.dll')
endif

" ä¿®æ­£ clang++ çš„å¤´æ–‡ä»¶æœç´¢è·¯å¾„çš„é—®é¢˜
command! -nargs=0 VIMCCCFixup VIMCCCAppendArgs
        \ -I/usr/lib/gcc/i486-linux-gnu/4.4.3/include
        \ -I/usr/lib/gcc/i486-linux-gnu/4.4.3/include-fixed 

let g:VLWorkspaceSymbolDatabase = 'cscope'
let g:VimTagsManager_InclAllCondCmplBrch = 1
" pyclewn çš„ç»ˆç«¯çª—å£é«˜åº¦ï¼Œæš‚æ—¶è¿™æ ·è®¾ç½®
set previewheight=8
"}}}
" ========== VIMCCC ==========
"{{{
let g:VIMCCC_Enable = 0
"let g:VIMCCC_ItemSelectionMode = 10
let g:VIMCCC_ItemSelectionMode = 2
"let g:VIMCCC_PythonModulePath = ''
let g:VIMCCC_ClangLibraryPath = ''
let g:VIMCCC_CompleteMacros = 1
"}}}
" ========== clang complete ==========
"{{{
let g:clang_use_library = 1
let g:clang_auto_select = 1
let g:clang_complete_macros=1
let g:clang_complete_patterns=0
let g:clang_complete_copen = 1
let g:clang_hl_errors = 0
let g:clang_periodic_quickfix = 0
let g:clang_snippets = 0
"let g:clang_library_path = '/usr/lib/libclang.so'
let g:clang_disable = 1
"let g:clic_filename = '/home/eph/clang_indexer.db'
"}}}
" ========== pathogen ==========
"{{{
call pathogen#infect()
"}}}
" ========== xptemplate ==========
"{{{
" é€‰æ‹©æ¨¡å¼ä¸‹å–æ¶ˆ j, k åŸå§‹çš„è¡Œä¸º
snoremap j <C-g>cj
snoremap k <C-g>ck

if has('gui_running')
    "let g:xptemplate_nav_next = '<C-CR>'
    "let g:xptemplate_nav_prev = '<S-CR>'
    let g:xptemplate_nav_next = '<C-o>'
    let g:xptemplate_nav_prev = '<S-Tab>'
else
    let g:xptemplate_nav_next = '<C-o>'
    let g:xptemplate_nav_prev = '<S-Tab>'
endif
let g:xptemplate_nav_cancel = '<C-c>'
let g:xptemplate_key = '<C-\>'
inoremap <silent> <expr> <C-p> pumvisible() ? "\<C-p>" :
            \"\<C-r>=XPTemplateStart(0,{'k':'<C-p++'})\<CR>"
"}}}
" ========== mark ==========
"{{{
function! s:MouseMark() "{{{2
    if &ft == "help"
        execute "normal! \<C-]>"
        return
    endif
    let l:C = getline('.')[col('.')-1]
    if l:C == '(' || l:C == ')'
                \|| l:C == '[' || l:C == ']'
                \|| l:C == '{' || l:C == '}'
                \|| &buftype ==# 'quickfix'
        execute "normal! \<2-LeftMouse>"
        return
    endif
    let l:bak = &ignorecase
        normal \\
    let &ignorecase = l:bak
endf
"}}}2
let g:mwIgnoreCase = 0
nmap <silent> \\ <Plug>MarkSet
xmap <silent> \\ <Plug>MarkSet
nmap <silent> \c :noh<CR><Plug>MarkAllClear
nmap <silent> * <Plug>MarkSearchCurrentNext
nmap <silent> # <Plug>MarkSearchCurrentPrev
nmap <silent> <Leader>* <Plug>MarkSearchNext
nmap <silent> <Leader># <Plug>MarkSearchPrev
nnoremap <silent> <2-LeftMouse> :call <SID>MouseMark()<CR>
"}}}
" ========== vim-signature ==========
" yz ç•™ç»™ xptemplate ç”¨ï¼Œæš‚æ—¶æ²¡åŠæ³•
let g:SignatureIncludeMarks =
            \ 'abcdefghijklmnopqrstuvwxABCDEFGHIJKLMNOPQRSTUVWXYZ'
"{{{
"}}}

"===============================================================================
" IDE è®¾ç½®
"===============================================================================
"set tags+=~/.vim/systags
let g:c_kernel_mode = 1

command -nargs=0 CKernelMode setlocal ts=8 sts=0 sw=8 noet
command -nargs=0 CSpaceMode setlocal ts=8 sts=4 sw=4 et

" ### Mark.vim å¿«é€Ÿé«˜äº®å•è¯ã€‚
" è‡ªå®šä¹‰é«˜äº®ï¼Œé»˜è®¤æœ‰ 6 ç»„
highlight HiWord1 gui=bold guifg=yellow guibg=#445599 
            \cterm=NONE ctermfg=black ctermbg=yellow
highlight HiWord2 gui=bold guifg=white guibg=#445599 
            \cterm=NONE ctermfg=black ctermbg=white
highlight HiWord3 gui=bold guifg=orange guibg=#445599 
            \cterm=NONE ctermfg=black ctermbg=Magenta
highlight HiWord4 gui=bold guifg=green guibg=#445599 
            \cterm=NONE ctermfg=black ctermbg=green
highlight HiWord5 gui=bold guifg=cyan guibg=#445599 
            \cterm=NONE ctermfg=black ctermbg=cyan
highlight HiWord6 gui=bold guifg=salmon guibg=#445599 
            \cterm=NONE ctermfg=black ctermbg=red
highlight HiWord7 gui=bold guifg=olivedrab3 guibg=#445599 
            \cterm=NONE ctermfg=black ctermbg=blue

" æ‹¬å·è‡ªåŠ¨è¡¥å…¨. ä¸ºäº†æ€§èƒ½, ç›´æ¥ç¦ç”¨é—­åˆæ£€æŸ¥
inoremap ( ()<Left>
"inoremap ) <C-r>=ClosePair(')')<CR>
inoremap [ []<Left>
"inoremap ] <C-r>=ClosePair(']')<CR>
"inoremap <expr> { (&filetype != "vimwiki")?"{}\<Left>":"{"
"inoremap } <C-r>=ClosePair('}')<CR>
"inoremap < <><Left>
"inoremap > <c-r>=ClosePair('>')<CR>
"inoremap ' ''<Left>
inoremap <expr> " (&filetype == "vim")?"\"":"\"\"\<Left>"

inoremap <expr> <BS> <SID>i_BS_plus()
inoremap <expr> ; <SID>i_Semicolon_plus()
inoremap <C-g> <C-r>=<SID>i_InsertHGuard()<CR>

" è¡¥å…¨æ¨¡å¼ä¸‹çš„æ˜ å°„
inoremap <expr> <CR> pumvisible()?"\<C-y>":"\<CR>"
"inoremap <expr> <ESC> pumvisible()?"\<C-e>":"\<ESC>"

" C çš„ç»“æ„æˆå‘˜è‡ªåŠ¨æç¤º
"inoremap <silent> . .<C-r>=<SID>i_PopupMember()<CR>
"inoremap <silent> > ><C-r>=<SID>i_PopupMember()<CR>

function! s:i_PopupMember() "{{{
    if &filetype != "c" && &filetype != "cpp"
        return ''
    endif
    let preChar = getline('.')[col('.') - 2]
    if ((getline('.')[col('.') - 3] == '-' && preChar == '>') || preChar == '.') && getline('.')[0] != '#'
        return "\<C-x>\<C-o>"
    else
        return ''
    endif
endf
"}}}
function! s:i_InsertHGuard() "{{{
    let gudname = "__".substitute(toupper(expand("%:t")), "\\.", "_", "g")."__"
    return "#ifndef ".gudname."\<CR>"."#define ".gudname."\<CR>\<CR>\<CR>\<CR>\<CR>\<CR>"."#endif /* ".gudname." */\<Up>\<Up>\<Up>"
endf
"}}}
function! s:i_Tab_plus_old() "{{{
    if (&filetype == "c" || &filetype == "cpp") && !pumvisible()
        return "\<Tab>"
    elseif !pumvisible()
        return "\<C-x>\<C-n>"
    elseif pumvisible()
        return "\<C-n>"
    endif
endf
"}}}
function! ClosePair(char) "{{{
    if getline('.')[col('.') - 1] == a:char
        return "\<Right>"
    else
        return a:char
    endif
endf
"}}}
function! s:i_Semicolon_plus() "{{{
    let sLine = getline('.')
    if sLine !~# '^\s*for\>' && sLine[col('.') - 1] ==# ')'
        return "\<Right>;"
    else
        return ";"
    endif
endf
"}}}
function! IfPair(char1,char2) "{{{
    if getline('.')[col('.') - 2] == a:char1 && getline('.')[col('.') - 1] == a:char2
        return 1
    else
        return 0
    endif
endf
"}}}
function! s:i_BS_plus() "{{{
    if IfPair('(',')') || IfPair('[',']')
        return "\<DEL>\<BS>"
    else
        return "\<BS>"
    endif
endf
"}}}

" ========== cscope è®¾ç½® ==========
"{{{
if has("cscope")
    if has("win32") || has("win64")
        let &csprg = $VIM . '\vimfiles\bin\cscope.exe'
    else
        set csprg=cscope
    endif
    set csto=0
    set cst
    set nocsverb
    " add any database in current directory
    if filereadable("cscope.out")
        cs add cscope.out
    " else add database pointed to by environment
    elseif $CSCOPE_DB != ""
        cs add $CSCOPE_DB
    elseif filereadable("GTAGS") " ä½¿ç”¨ gtags
        set csprg=gtags-cscope
        cs add GTAGS
    endif
    set csverb
    set cscopequickfix=s-,c-,d-,i-,t-,e-
endif

"set nocsverb
"if has("cscope") && filereadable("../cscope.out")
    "cs add ../cscope.out ../
"endif
"set csverb

function! s:Addcs(name)
    let prePath = fnamemodify(a:name, ':p:h')
    execute "cs add " . a:name . " " . prePath
endf
command! -complete=file -nargs=1 Addcs :call <SID>Addcs("<args>")

nnoremap <C-\>s :cs find s <C-R>=expand("<cword>")<CR><CR>
nnoremap <C-\>g :cs find g <C-R>=expand("<cword>")<CR><CR>
nnoremap <C-\>c :cs find c <C-R>=expand("<cword>")<CR><CR>
nnoremap <C-\>t :cs find t <C-R>=expand("<cword>")<CR><CR>
nnoremap <C-\>e :cs find e <C-R>=expand("<cword>")<CR><CR>
nnoremap <C-\>f :cs find f <C-R>=expand("<cfile>")<CR><CR>
nnoremap <C-\>i :cs find i ^<C-R>=expand("<cfile>")<CR>$<CR>
nnoremap <C-\>d :cs find d <C-R>=expand("<cword>")<CR><CR>

"nnoremap <silent> <C-\>a :call <SID>AlterSource()<CR>

function! s:AlterSource() "{{{
    let l:file = expand("%:t:r")
    let l:ext = expand("%:t:e")
    if l:ext == "c" || l:ext == "cpp"
        try
            exec 'cs find f \<' . l:file . ".h$"
        catch
            try
                exec 'cs find f \<' . l:file . ".hpp$"
            catch
                return
            endtry
            return
        endtry
    elseif l:ext == "h" || l:ext == "hpp"
        try
            exec 'cs find f \<' . l:file . ".c$"
        catch
            try
                exec 'cs find f \<' . l:file . ".cpp$"
            catch
                return
            endtry
            return
        endtry
    endif
endf
"}}}
"}}}

"===========================================================
" è‡ªå·±çš„ç®€æ˜“æ’ä»¶
"===========================================================
" ========== SimpleSuperTab ==========
"{{{
" éœ€è¦æŠŠ completeopt è®¾ç½®ä¸º menuone
inoremap <C-Tab> <Tab>
inoremap <silent> <Tab> <C-r>=<SID>i_Tab_plus()<CR>
inoremap <silent> <expr> <S-Tab> pumvisible()?"\<C-p>":"\<C-d>"

function! s:i_Tab_plus() "{{{2
    let preChar = getline('.')[col('.') - 2]
    if pumvisible()
        return "\<C-n>"
    elseif preChar == '' || preChar =~ '\s'
        return "\<Tab>"
    elseif (getline('.')[col('.') - 3] == '-' && preChar == '>') || preChar == '.'
        return "\<C-x>\<C-o>"
    elseif &ft ==# 'c' || &ft ==# 'cpp'
        return "\<C-n>"
    else
        return "\<C-x>\<C-n>"
    endif
endf
"}}}2
function! I_OnPopupPost() "{{{2
    return pumvisible()?"\<C-p>\<Down>":""
endf
"}}}2
"}}}
" ========== é€’å½’æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶å¹¶æ‰“å¼€ ==========
"{{{
function! s:findn(name, flag)
    if a:flag == "c"
    let l:list=system("find . -path '*.svn' -prune -o -iname '*" . a:name . "*' -type f \\( -iname '*.c' -o -iname '*.h' -o -iname '*.cpp' \\) -print | awk '{print NR\"\t\"$0}'")
    else
    let l:list=system("find . -path '*.svn' -prune -o -iname '*" . a:name . "*' -type f -print | awk '{print NR\"\t\"$0}'")
    endif

    let l:num=strlen(substitute(l:list, "[^\n]", "", "g"))
    if l:num < 1
        echo "'" . a:name . "' not found"
        return
    endif
    if l:num != 1
        echo l:list
        let l:input=input("Type number and <Enter> (empty cancels): ")

        if strlen(l:input)==0
            return
        endif

        if strlen(substitute(l:input, "[0-9]", "", "g"))>0
            echo "Not a number"
            return
        endif

        if l:input<1 || l:input>l:num
            echo "Out of range"
            return
        endif
        let l:line=matchstr("\n".l:list, "\n".l:input."\t[^\n]*")
    else
        let l:line=l:list
    endif

    let l:line=substitute(l:line, "^[^\t]*\t./", "", "")
    execute ":e " . l:line
endf
" æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶
command! -nargs=1 Findn :call <SID>findn("<args>", "")
" æŸ¥æ‰¾ c æ–‡ä»¶
command! -nargs=1 Findc :call <SID>findn("<args>", "c")
"}}}
" ========== åœ¨é¢„è§ˆçª—å£æ˜¾ç¤ºæ ‡ç­¾å†…å®¹ ==========
"{{{
nnoremap <silent> <CR> :call PreviewWord()<CR>
function! PreviewWord() "{{{2
    if &ft ==# 'qf'
        exec "normal! \<CR>"
        return
    endif

    if &previewwindow
        let flag = 1
    else
        let flag = 0
    endif

    let orgbuf = bufnr('%')
    let w = expand("<cword>")       " åœ¨å½“å‰å…‰æ ‡ä½ç½®æŠ“è¯
    if w =~ '\a'                    " å¦‚æœè¯¥å•è¯åŒ…æ‹¬ä¸€ä¸ªå­—æ¯
        let l:bak_shm = &shm
        let l:bak_ei = &ei
        set eventignore+=BufEnter,WinEnter,BufWinEnter "TODO: éœ€è¦æ›´å¥½çš„æ–¹æ¡ˆ
        set shortmess+=A

        if &filetype == "help"
            exec "normal! \<C-w>}"
        else
            try
                exec "ptag " . w
            catch
                let &shm = l:bak_shm
                let &ei = l:bak_ei
                return
            endtry
        endif

        let &shm = l:bak_shm
        let &ei = l:bak_ei

        let orgWinnr = winnr()

        " è·³è½¬è‡³é¢„è§ˆçª—å£
        try
            noautocmd wincmd P
        catch /.*/
            return
        endtry
        if &previewwindow           " å¦‚æœç¡®å®è½¬åˆ°äº†é¢„è§ˆçª—å£â€¦â€¦

"           if !buflisted(orgbuf)   " å¦‚æœéœ€è¦æ‰“å¼€çš„é¢„è§ˆç¼“å†²æ²¡æœ‰åœ¨å¯ç”¨ç¼“å†²åˆ—è¡¨
"               setlocal buftype=nowrite
"               setlocal bufhidden=delete
"               setlocal noswapfile
"               setlocal nobuflisted
"               setlocal noma
"           endif

            if has("folding")
                silent! .foldopen   " å±•å¼€æŠ˜å çš„è¡Œ
            endif

"           call search("$", "b")   " åˆ°å‰ä¸€è¡Œçš„è¡Œå°¾
            let w = substitute(w, '\\', '\\\\', "")
"           call search('\<\V' . w . '\>')      " å®šä½å…‰æ ‡åœ¨åŒ¹é…çš„å•è¯ä¸Š
            call search('\<\V' . w . '\>', "c") " å®šä½å…‰æ ‡åœ¨åŒ¹é…çš„å•è¯ä¸Š
            " ç»™åœ¨æ­¤ä½ç½®çš„å•è¯åŠ ä¸ŠåŒ¹é…é«˜äº®
            "hi PreviewWord guifg=cyan guibg=grey40 term=bold ctermbg=green
            hi link PreviewWord Search
            exec 'match PreviewWord "\%' . line(".") . 'l\%' . col(".") . 'c\k*"'
            normal! zz

            if flag == 0
                " è¿”å›åŸæ¥çš„çª—å£
                exec 'noautocmd' orgWinnr 'wincmd w'
            endif
        endif
    endif
endf
"}}}2
"}}}
" ========== ä¿®æ­£ MiniBufExplorer çª—å£ ==========
"{{{
"nnoremap \j :call <SID>FixMiniBuf()<CR>
function! s:FixMiniBuf() "{{{2
    let l:orgWinnr = winnr()
    NERDTree
    Tlist
    let l:orgWinnr += 2

    let l:MBEWinnr = bufwinnr("-MiniBufExplorer-")

    if l:MBEWinnr != -1
        exec l:MBEWinnr . " wincmd w"
        normal! l
    endif

    if bufname('%') == '-MiniBufExplorer-'
        let l:MBEWinhei = winheight(0)
        exec "to " . l:MBEWinhei . " sp"
"       exec l:MBEWinnr . " wincmd w"
        wincmd p
        close
    endif

    exec l:orgWinnr . " wincmd w"
endf
"}}}2
"}}}
" ========== å¿«é€Ÿåˆ‡æ¢â€œå…¨è£…å¤‡â€æ¨¡å¼ ==========
"{{{
"nnoremap \t :call <SID>ToggleTlistAndNERDTree(90)<CR>
function! s:ToggleTlistAndNERDTree(width) "{{{2
    let l:TL = "__Tag_List__"
    let l:NT = "NERD_tree_1"
    let l:BE = "__BufExplorer__"
    let l:ifTL = bufwinnr(l:TL)
    let l:ifNT = bufwinnr(l:NT)
    let l:orgWinnr = winnr()

    "ä»»ä½•ä¸€ä¸ªæ‰“å¼€ï¼Œéƒ½å…ˆå…¨å…³äº†
    if l:ifNT != -1 || l:ifTL != -1 || bufwinnr(l:BE) != -1
        if bufwinnr(l:BE) != -1
            execute bufwinnr(l:BE) . "wincmd w"
            close
            let l:orgWinnr -= 1
            execute l:orgWinnr . "wincmd w"
        endif
        if l:ifNT != -1
            NERDTreeToggle
        endif
        if l:ifTL != -1
            TlistClose
        endif
        execute "set columns=" . a:width
    else
        NERDTreeToggle
        vertical resize 30
        wincmd p
        TlistOpen
        wincmd p
        if &columns <= a:width
            set columns+=60
        endif

        let l:orgWinnr = winnr()
        execute bufwinnr(l:NT) . "wincmd w"
        normal! zz
        BufExplorerHorizontalSplit
        if winnr() <= l:orgWinnr
            let l:orgWinnr += 1
        endif
        execute l:orgWinnr . "wincmd w"
        call BufExplorer_Fix()
    endif
endf
"}}}2
"}}}
" ========== å¿«é€Ÿåˆ‡æ¢â€œè½»è£…å¤‡â€æ¨¡å¼ ==========
"{{{
"nnoremap \m :call <SID>ToggleNERDTreeAndBE(90)<CR>
function! s:ToggleNERDTreeAndBE(width) "{{{2
    let l:NT = "NERD_tree_1"
    let l:BE = "__BufExplorer__"
    let l:ifNT = bufwinnr(l:NT)
    let l:orgWinnr = winnr()

    " ä»»ä½•ä¸€ä¸ªæ‰“å¼€ï¼Œéƒ½å…ˆå…¨å…³äº†
    if l:ifNT != -1 || bufwinnr(l:BE) != -1
        if bufwinnr(l:BE) != -1
            execute bufwinnr(l:BE) . "wincmd w"
            close
            let l:orgWinnr -= 1
            execute l:orgWinnr . "wincmd w"
        endif

        if l:ifNT != -1
            NERDTreeToggle
        endif

"       execute "set columns=" . a:width
        set columns-=30
    else
        NERDTreeToggle
        vertical resize 30
        wincmd p
        set columns+=30

        let l:orgWinnr = winnr()
        execute bufwinnr(l:NT) . "wincmd w"
        normal! zz
        BufExplorerHorizontalSplit
        if winnr() <= l:orgWinnr
            let l:orgWinnr += 1
        endif
        execute l:orgWinnr . "wincmd w"
        call BufExplorer_Fix()
    endif
endf
"}}}2
"}}}
" ========== å–è‰²å™¨ï¼Œé…åˆ colorsel ä½¿ç”¨ ==========
"{{{
"nnoremap <Leader>c :execute "ColorSel " . <SID>PickColor2Colorsel()<CR>
function! s:PickColor2Colorsel() "{{{2
    if !exists("$DISPLAY") || !executable("colorpicker")
        return ""
    endif
    let l:color = substitute(system("colorpicker"), '\n', '', '')
    return l:color
endf
"}}}2
"}}}
" ========== éšè—æ··ä¹±çš„æ–‡ä»¶æ ¼å¼ä¸­çš„ ^M å­—ç¬¦ ==========
"{{{
autocmd BufReadPost * nested call <SID>FixDosFmt()
function! s:FixDosFmt() "{{{2
    if &ff == 'unix'
        " æœç´¢ ^M
        let nStopLine = 0
        let nTimeOut = 100
        let nRet = search('\r$', 'nc', nStopLine, nTimeOut)
        if nRet > 0
            e ++ff=dos
            "redraw
            "echo 'File format has been set to UNIX.'
        endif
    endif
endfunction
"}}}2
"}}}

"-------------------------------------------------------------------------------
" vim: fdm=marker fen fdl=0 expandtab softtabstop=4
